{% extends 'videos/base.html' %}

{% block title %}분석 진행 중...{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3>전처리 진행 중</h3>
            </div>
            <div class="card-body text-center">
                <h4>{{ video.title }}</h4>
                
                <!-- 진행 상태 -->
                <div class="my-4">
                    <div id="statusBadge" class="badge bg-info fs-5 mb-3">초기화 중...</div>
                    
                    <!-- 프로그레스 바 -->
                    <div class="progress mb-3" style="height: 30px;">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%">
                            <span id="progressText">0%</span>
                        </div>
                    </div>
                    
                    <!-- 상세 정보 -->
                    <div id="statusDetails" class="text-muted">
                        <p id="currentStep">준비 중...</p>
                        <p id="frameInfo">프레임: 0 / 0</p>
                    </div>
                </div>

                <!-- 로딩 스피너 -->
                <div id="loadingSpinner">
                    <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status">
                        <span class="visually-hidden">처리 중...</span>
                    </div>
                    <p class="mt-3">동영상을 처리하고 있습니다. 잠시만 기다려주세요...</p>
                </div>

                <!-- 완료 메시지 (숨김) -->
                <div id="completedMessage" style="display: none;">
                    <div class="alert alert-success">
                        <h4><i class="bi bi-check-circle"></i> 전처리 완료!</h4>
                        <p>결과를 확인하세요.</p>
                    </div>
                    <a href="{% url 'analysis_result' analysis.id %}" class="btn btn-primary btn-lg">
                        결과 보기
                    </a>
                </div>

                <!-- 에러 메시지 (숨김) -->
                <div id="errorMessage" style="display: none;">
                    <div class="alert alert-danger">
                        <h4><i class="bi bi-exclamation-triangle"></i> 오류 발생</h4>
                        <p id="errorText"></p>
                    </div>
                    <a href="{% url 'start_analysis' video.id %}" class="btn btn-warning">
                        다시 시도
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const analysisId = '{{ analysis.id }}';

// 상태 확인 함수
function checkStatus() {
    fetch(`/analysis/${analysisId}/status/`)
        .then(response => response.json())
        .then(data => {
            // 진행률 업데이트
            const progress = data.progress || 0;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = progress + '%';
            
            // 현재 단계
            document.getElementById('currentStep').textContent = data.current_step || '처리 중...';
            
            // 프레임 정보
            if (data.total_frames > 0) {
                document.getElementById('frameInfo').textContent = 
                    `프레임: ${data.processed_frames} / ${data.total_frames}`;
            }
            
            // 상태에 따른 처리
            if (data.status === 'completed') {
                // 완료
                document.getElementById('statusBadge').className = 'badge bg-success fs-5 mb-3';
                document.getElementById('statusBadge').textContent = '완료';
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('completedMessage').style.display = 'block';
                document.getElementById('progressBar').className = 'progress-bar bg-success';
                
            } else if (data.status === 'failed') {
                // 실패
                document.getElementById('statusBadge').className = 'badge bg-danger fs-5 mb-3';
                document.getElementById('statusBadge').textContent = '실패';
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorText').textContent = data.error_message || '알 수 없는 오류';
                document.getElementById('progressBar').className = 'progress-bar bg-danger';
                
            } else if (data.status === 'processing') {
                // 처리 중
                document.getElementById('statusBadge').className = 'badge bg-primary fs-5 mb-3';
                document.getElementById('statusBadge').textContent = '처리 중';
                
                // 3초 후 다시 확인
                setTimeout(checkStatus, 3000);
            } else {
                // 대기 중
                document.getElementById('statusBadge').className = 'badge bg-info fs-5 mb-3';
                document.getElementById('statusBadge').textContent = '대기 중';
                
                // 2초 후 다시 확인
                setTimeout(checkStatus, 2000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            setTimeout(checkStatus, 5000);
        });
}

// 페이지 로드 시 상태 확인 시작
checkStatus();
</script>
{% endblock %}