{% extends 'videos/base.html' %}

{% block title %}ë¶„ì„ ê²°ê³¼{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="alert alert-success">
            <h4><i class="bi bi-check-circle"></i> ì „ì²˜ë¦¬ ì™„ë£Œ!</h4>
        </div>
    </div>
</div>

<div class="row">
    <!-- ì›ë³¸ ë™ì˜ìƒ -->
    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header">
                <h4>ì›ë³¸ ë™ì˜ìƒ</h4>
            </div>
            <div class="card-body">
                <video width="100%" controls preload="metadata">
                    <source src="{% url 'serve_video' video.pk %}" type="video/mp4">
                </video>
                <div class="mt-2">
                    <p class="text-muted mb-1">{{ video.title }}</p>
                    <small>í¬ê¸°: {{ video.get_file_size_display }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- ì²˜ë¦¬ëœ ë™ì˜ìƒ -->
    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header">
                <h4>ì²˜ë¦¬ëœ ë™ì˜ìƒ</h4>
            </div>
            <div class="card-body">
                <video width="100%" controls preload="metadata">
                    <source src="{% url 'serve_analysis_video' analysis.id %}" type="video/mp4">
                    ë¸Œë¼ìš°ì €ê°€ ë™ì˜ìƒ ì¬ìƒì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                </video>
                
                <!-- ì •ë³´ì™€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì¢Œìš° ë°°ì¹˜ -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div>
                        <p class="text-muted mb-1">ì „ì²˜ë¦¬ ì™„ë£Œ</p>
                        <small>í”„ë ˆì„: {{ analysis.processed_frames }}</small>
                    </div>
                    <div>
                        <a href="{% url 'serve_analysis_video' analysis.id %}" 
                        download="processed_{{ video.file.name }}" 
                        class="btn btn-success">
                            <i class="bi bi-download"></i> ë‹¤ìš´ë¡œë“œ
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- íŒŒì´í”„ë¼ì¸ ì •ë³´ -->
<div class="row">
    <div class="col-md-12">
        <div class="card mb-3">
            <div class="card-header">
                <h4>ì ìš©ëœ ì „ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸</h4>
            </div>
            <div class="card-body">
                <ol>
                    {% for step in analysis.get_pipeline_display %}
                    <li>{{ step }}</li>
                    {% endfor %}
                </ol>
                
                <div class="mt-3">
                    <p><strong>ì²˜ë¦¬ ì‹œê°„:</strong> 
                        {% if analysis.started_at and analysis.completed_at %}
                            {{ analysis.get_duration|floatformat:1 }}ì´ˆ
                        {% endif %}
                    </p>
                    <p><strong>ì´ í”„ë ˆì„:</strong> {{ analysis.total_frames }}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì•¡ì…˜ ë²„íŠ¼ -->
<div class="card mb-4">
    <div class="card-body">
        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
            <!-- ëª¨ë¸ ì ìš© -->
            {% if analysis.status == 'completed' %}
            <a href="{% url 'start_detection' analysis.id %}" class="btn btn-primary">
                <i class="bi bi-cpu"></i> ëª¨ë¸ ì ìš©
            </a>
            {% else %}
            <button class="btn btn-secondary" disabled title="ë¶„ì„ì´ ì™„ë£Œë˜ì–´ì•¼ í•©ë‹ˆë‹¤">
                <i class="bi bi-cpu"></i> ëª¨ë¸ ì ìš©
            </button>
            {% endif %}
            
            <!-- ë‹¤ì‹œ ì „ì²˜ë¦¬ -->
            <a href="{% url 'start_analysis' video.id %}" class="btn btn-warning">
                <i class="bi bi-arrow-counterclockwise"></i> ë‹¤ì‹œ ì „ì²˜ë¦¬í•˜ê¸°
            </a>
            
            <!-- ëŒì•„ê°€ê¸° -->
            <a href="{% url 'video_detail' video.id %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> ë™ì˜ìƒìœ¼ë¡œ ëŒì•„ê°€ê¸°
            </a>
        </div>
    </div>
</div>

<script>
const processedVideo = document.getElementById('processedVideo');

function reloadVideo() {
    console.log('ğŸ”„ ë™ì˜ìƒ ë‹¤ì‹œ ë¡œë“œ');
    processedVideo.load();
}

if (processedVideo) {
    console.log('ğŸ¬ ë™ì˜ìƒ ìš”ì†Œ:', processedVideo);
    console.log('ğŸ¬ ì†ŒìŠ¤ URL:', processedVideo.querySelector('source')?.src);
    
    // ê°•ì œë¡œ ë¡œë“œ ì‹œë„
    processedVideo.load();
    
    processedVideo.addEventListener('loadstart', function() {
        console.log('ğŸ“¥ loadstart');
    });
    
    processedVideo.addEventListener('loadedmetadata', function() {
        console.log('âœ… loadedmetadata');
        console.log('Duration:', processedVideo.duration);
        console.log('ReadyState:', processedVideo.readyState);
    });
    
    processedVideo.addEventListener('loadeddata', function() {
        console.log('âœ… loadeddata');
    });
    
    processedVideo.addEventListener('canplay', function() {
        console.log('âœ… canplay - ì¬ìƒ ê°€ëŠ¥!');
    });
    
    processedVideo.addEventListener('canplaythrough', function() {
        console.log('âœ… canplaythrough - ì „ì²´ ì¬ìƒ ê°€ëŠ¥!');
    });
    
    processedVideo.addEventListener('progress', function() {
        if (processedVideo.buffered.length > 0) {
            const bufferedEnd = processedVideo.buffered.end(0);
            const duration = processedVideo.duration;
            const percent = (bufferedEnd / duration * 100).toFixed(2);
            console.log(`ğŸ“Š ë²„í¼ë§: ${percent}% (${bufferedEnd.toFixed(2)}s / ${duration.toFixed(2)}s)`);
        }
    });
    
    processedVideo.addEventListener('waiting', function() {
        console.log('â³ waiting - ë²„í¼ë§ ì¤‘');
    });
    
    processedVideo.addEventListener('stalled', function() {
        console.warn('âš ï¸  stalled - ë¡œë”© ë©ˆì¶¤');
    });
    
    processedVideo.addEventListener('suspend', function() {
        console.log('â¸ï¸  suspend - ë¡œë”© ì¼ì‹œì¤‘ë‹¨');
    });
    
    processedVideo.addEventListener('error', function(e) {
        console.error('âŒ ì—ëŸ¬!');
        console.error('Error code:', processedVideo.error?.code);
        console.error('Error message:', processedVideo.error?.message);
        console.error('Network state:', processedVideo.networkState);
        console.error('Ready state:', processedVideo.readyState);
        
        alert('ë™ì˜ìƒ ë¡œë“œ ì‹¤íŒ¨! F12 ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.');
    });
}
</script>


{% endblock %}