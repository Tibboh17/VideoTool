{% extends 'videos/base.html' %}

{% block title %}감지 진행 중{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h1 class="mb-4">
                <i class="bi bi-hourglass-split"></i> 감지 진행 중
            </h1>

            <!-- 진행 상황 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">진행 상황</h5>
                </div>
                <div class="card-body">
                    <!-- 상태 배지 -->
                    <div class="mb-3 text-center">
                        <h4>
                            <span id="statusBadge" class="badge bg-primary">진행 중</span>
                        </h4>
                    </div>

                    <!-- 진행률 바 -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>진행률</span>
                            <span><strong id="progressPercent">0</strong>%</span>
                        </div>
                        <div class="progress" style="height: 30px;">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%">
                                <span id="progressText">0%</span>
                            </div>
                        </div>
                    </div>

                    <!-- 프레임 정보 -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>처리된 프레임:</span>
                            <strong><span id="processedFrames">0</span> / <span id="totalFrames">0</span></strong>
                        </div>
                    </div>

                    <!-- 에러 메시지 -->
                    <div id="errorMessage" class="alert alert-danger" style="display: none;">
                        <h6><i class="bi bi-exclamation-triangle"></i> 오류 발생</h6>
                        <p id="errorText" class="mb-0"></p>
                    </div>
                </div>
            </div>

            <!-- 감지 정보 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">감지 정보</h5>
                </div>
                <div class="card-body">
                    <p class="mb-1"><strong>감지 ID:</strong> #{{ detection.id }}</p>
                    {% if detection.title %}
                    <p class="mb-1"><strong>제목:</strong> {{ detection.title }}</p>
                    {% endif %}
                    <p class="mb-1"><strong>동영상:</strong> {{ detection.analysis.video.title }}</p>
                    <p class="mb-0"><strong>모델:</strong> {{ detection.model.name }}</p>
                </div>
            </div>

            <!-- 완료 시 자동 이동 안내 -->
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                처리가 완료되면 자동으로 결과 페이지로 이동합니다.
            </div>

            <div class="d-grid">
                <a href="{% url 'analysis_result' detection.analysis.id %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> 분석 결과로 돌아가기
                </a>
            </div>
        </div>
    </div>
</div>

<script>
let checkInterval;

function updateProgress() {
    fetch('{% url "detection_status" detection.id %}')
        .then(response => response.json())
        .then(data => {
            console.log('Status:', data);
            
            // 진행률 업데이트
            const progress = data.progress || 0;
            document.getElementById('progressPercent').textContent = progress;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = progress + '%';
            
            // 프레임 정보 업데이트
            document.getElementById('processedFrames').textContent = data.processed_frames || 0;
            document.getElementById('totalFrames').textContent = data.total_frames || 0;
            
            // 상태에 따른 처리
            const statusBadge = document.getElementById('statusBadge');
            
            if (data.status === 'completed') {
                statusBadge.className = 'badge bg-success';
                statusBadge.textContent = '완료';
                
                clearInterval(checkInterval);
                
                // 2초 후 결과 페이지로 이동
                setTimeout(() => {
                    window.location.href = '{% url "detection_result" detection.id %}';
                }, 2000);
                
            } else if (data.status === 'failed') {
                statusBadge.className = 'badge bg-danger';
                statusBadge.textContent = '실패';
                
                clearInterval(checkInterval);
                
                // 에러 메시지 표시
                const errorDiv = document.getElementById('errorMessage');
                const errorText = document.getElementById('errorText');
                errorText.textContent = data.error_message || '알 수 없는 오류가 발생했습니다.';
                errorDiv.style.display = 'block';
                
            } else if (data.status === 'processing') {
                statusBadge.className = 'badge bg-primary';
                statusBadge.textContent = '진행 중';
            } else if (data.status === 'ready') {
                statusBadge.className = 'badge bg-secondary';
                statusBadge.textContent = '준비 중';
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

// 페이지 로드 시 시작
document.addEventListener('DOMContentLoaded', function() {
    updateProgress();
    checkInterval = setInterval(updateProgress, 2000); // 2초마다 체크
});
</script>
{% endblock %}