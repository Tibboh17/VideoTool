{% extends 'videos/base.html' %}

{% block title %}이미지 업로드{% endblock %}

{% block breadcrumb_items %}
<li class="custom-breadcrumb-item active">
    <a href="{% url 'upload_media' %}">
        <i class="bi bi-image"> </i> 이미지 업로드
    </a>
</li>
{% endblock %}

{% block content %}

<div class="row">
    <div class="col-md-12">
        <div class="breadcrumb-container">
            <nav aria-label="breadcrumb">
                <ol class="custom-breadcrumb">
                    <li class="custom-breadcrumb-item">
                        <a href="{% url 'media_list' %}">
                            <i class="bi bi-collection-play"></i> 미디어 목록
                        </a>
                    </li>
                    <li class="custom-breadcrumb-item active">
                        <a href="{% url 'upload_media' %}">
                            <i class="bi bi-image"></i> 이미지 업로드
                        </a>
                    </li>
                </ol>
            </nav>
        </div>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-header bg-white py-3">
                <h3 class="mb-0"><i class="bi bi-image me-2"></i>이미지 업로드</h3>
            </div>
            <div class="card-body p-4">
                <form method="post" enctype="multipart/form-data" id="uploadForm">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="{{ form.title.id_for_label }}" class="form-label">제목 *</label>
                        {{ form.title }}
                        {% if form.title.errors %}
                            <div class="text-danger mt-1 small">{{ form.title.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label">설명</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="text-danger mt-1 small">{{ form.description.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.file.id_for_label }}" class="form-label">이미지 파일 *</label>
                        {{ form.file }}
                        <div class="form-text">지원 형식: JPG, PNG, JPEG (최대 10MB)</div>
                        {% if form.file.errors %}
                            <div class="text-danger mt-1 small">{{ form.file.errors }}</div>
                        {% endif %}
                    </div>

                    <div id="imagePreview" class="mb-3" style="display: none;">
                        <label class="form-label d-block">미리보기</label>
                        <img id="previewImg" src="#" alt="미리보기" class="img-thumbnail" style="max-height: 200px;">
                    </div>

                    <div id="uploadProgress" class="mb-3" style="display: none;">
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" style="border-radius: 8px;">
                            업로드 시작
                        </button>
                        <a href="{% url 'media_list' %}" class="btn btn-outline-secondary">
                            취소
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <div class="mt-4 px-2">
            <div class="small text-muted">
                <h6 class="fw-bold small"><i class="bi bi-info-circle me-1"></i> 안내사항</h6>
                <ul class="ps-3 mb-0">
                    <li>이미지는 업로드 즉시 전처리 및 감지 모델이 적용됩니다.</li>
                    <li>고해상도 이미지는 처리 시간에 몇 초 정도 소요될 수 있습니다.</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// 이미지 미리보기 및 파일 체크
document.getElementById('{{ form.file.id_for_label }}').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const maxSize = 10 * 1024 * 1024;
        if (file.size > maxSize) {
            alert('파일 크기는 10MB를 초과할 수 없습니다.');
            this.value = '';
            document.getElementById('imagePreview').style.display = 'none';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('previewImg').src = e.target.result;
            document.getElementById('imagePreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
        
        const titleInput = document.getElementById('{{ form.title.id_for_label }}');
        if (!titleInput.value) {
            const filename = file.name.split('.')[0];
            titleInput.value = filename;
        }
    }
});

// 업로드 중 상태 표시 (Video와 동일한 로직)
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    const submitBtn = document.getElementById('submitBtn');
    const progress = document.getElementById('uploadProgress');
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class=\"spinner-border spinner-border-sm\"></span> 업로드 중...';
    progress.style.display = 'block';
    
    let percent = 0;
    const interval = setInterval(function() {
        percent += 10;
        if (percent <= 95) {
            progress.querySelector('.progress-bar').style.width = percent + '%';
            progress.querySelector('.progress-bar').textContent = percent + '%';
        } else {
            clearInterval(interval);
        }
    }, 100);
});
</script>
{% endblock %}